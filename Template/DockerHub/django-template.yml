---
# Django Web App Template
version: '3.8'
services:
  django:
    image: python:3.11-slim
    restart: always
    working_dir: /app
    ports: ["8000:8000"]
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: django
      POSTGRES_USER: django
      POSTGRES_PASSWORD: ${DB_PASSWORD:-djangopass}
      REDIS_URL: redis://redis:6379/0
    volumes: [./app:/app]
    command: sh -c "pip install -r requirements.txt && python manage.py migrate && python manage.py runserver 0.0.0.0:8000"
    depends_on: [postgres, redis]
  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_DB: django
      POSTGRES_USER: django
      POSTGRES_PASSWORD: ${DB_PASSWORD:-djangopass}
    volumes: [postgres_data:/var/lib/postgresql/data]
  redis:
    image: redis:7-alpine
    restart: always
    volumes: [redis_data:/data]
  nginx:
    image: nginx:alpine
    restart: always
    ports: ["80:80"]
    volumes: [./nginx.conf:/etc/nginx/nginx.conf:ro, ./static:/static:ro]
    depends_on: [django]
volumes:
  postgres_data:
  redis_data:
