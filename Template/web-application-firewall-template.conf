# Web Application Firewall Template - ModSecurity

# ModSecurity Configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# Logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0

# OWASP Core Rule Set
Include /etc/modsecurity/crs-setup.conf
Include /etc/modsecurity/rules/*.conf

# Custom Rules
SecRule REQUEST_HEADERS:Content-Type "text/xml" \
    "id:1000,phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"

SecRule REQUEST_HEADERS:Content-Type "application/json" \
    "id:1001,phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"

# SQL Injection Protection
SecRule ARGS "@detectSQLi" \
    "id:2000,phase:2,block,log,msg:'SQL Injection Attack Detected',severity:CRITICAL"

# XSS Protection
SecRule ARGS "@detectXSS" \
    "id:2001,phase:2,block,log,msg:'XSS Attack Detected',severity:CRITICAL"

# Path Traversal Protection
SecRule REQUEST_URI|ARGS "@pmFromFile /etc/modsecurity/path-traversal.data" \
    "id:2002,phase:2,block,log,msg:'Path Traversal Attack Detected',severity:WARNING"

# Rate Limiting
SecAction "id:3000,phase:1,nolog,pass,initcol:ip=%{REMOTE_ADDR}"
SecRule IP:REQUEST_COUNT "@gt 100" \
    "id:3001,phase:2,deny,status:429,log,msg:'Rate limit exceeded',setvar:ip.request_count=+1"

# Block Common Attack Tools
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile /etc/modsecurity/scanners-user-agents.data" \
    "id:4000,phase:1,block,log,msg:'Security Scanner Detected',severity:CRITICAL"

# File Upload Restrictions
SecRule FILES_TMPNAMES "@inspectFile /usr/local/bin/check_upload.sh" \
    "id:5000,phase:2,block,log,msg:'Malicious File Upload Detected'"

# IP Reputation
SecRule REMOTE_ADDR "@ipMatchFromFile /etc/modsecurity/blacklist.txt" \
    "id:6000,phase:1,deny,status:403,log,msg:'IP Blacklisted'"

# Geo-blocking (example)
SecRule REMOTE_ADDR "@geoLookup" \
    "id:7000,phase:1,chain,drop,log,msg:'Connection from blocked country'"
SecRule GEO:COUNTRY_CODE "@streq CN" "t:none"
