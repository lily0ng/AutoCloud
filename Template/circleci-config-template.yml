# CircleCI Configuration Template
version: 2.1

orbs:
  node: circleci/node@5.1
  docker: circleci/docker@2.2
  kubernetes: circleci/kubernetes@1.3

executors:
  node-executor:
    docker:
      - image: cimg/node:18.17
    resource_class: medium

jobs:
  install-dependencies:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - persist_to_workspace:
          root: .
          paths:
            - node_modules

  lint:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Run ESLint
          command: npm run lint

  test-unit:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Run Unit Tests
          command: npm run test:unit
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage

  build-docker:
    executor: docker/docker
    steps:
      - checkout
      - setup_remote_docker
      - docker/check
      - docker/build:
          image: myapp
          tag: << pipeline.git.revision >>
      - docker/push:
          image: myapp
          tag: << pipeline.git.revision >>

  deploy-staging:
    executor: kubernetes/default
    steps:
      - kubernetes/install-kubectl
      - run:
          name: Deploy to Staging
          command: |
            kubectl set image deployment/myapp myapp=myapp:<< pipeline.git.revision >> -n staging
            kubectl rollout status deployment/myapp -n staging

workflows:
  build-test-deploy:
    jobs:
      - install-dependencies
      - lint:
          requires:
            - install-dependencies
      - test-unit:
          requires:
            - install-dependencies
      - build-docker:
          requires:
            - lint
            - test-unit
          filters:
            branches:
              only: [main, develop]
      - deploy-staging:
          requires:
            - build-docker
          filters:
            branches:
              only: develop
