---
# Deployment Rollback Template
# Automated rollback strategies

apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: app-with-rollback
  namespace: production
spec:
  replicas: 5
  revisionHistoryLimit: 5
  
  selector:
    matchLabels:
      app: myapp
  
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: app
        image: myapp:latest
        ports:
        - containerPort: 8080
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
  
  strategy:
    canary:
      steps:
      - setWeight: 20
      - pause: {duration: 2m}
      
      - analysis:
          templates:
          - templateName: error-rate-check
          args:
          - name: service-name
            value: myapp
      
      - setWeight: 50
      - pause: {duration: 5m}
      
      - analysis:
          templates:
          - templateName: performance-check
          args:
          - name: service-name
            value: myapp
      
      - setWeight: 100
      
      # Auto rollback on failure
      abortScaleDownDelaySeconds: 30
---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: error-rate-check
  namespace: production
spec:
  args:
  - name: service-name
  metrics:
  - name: error-rate
    interval: 1m
    count: 5
    successCondition: result < 0.05
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus:9090
        query: |
          sum(rate(http_requests_total{service="{{args.service-name}}",status=~"5.."}[2m]))
          /
          sum(rate(http_requests_total{service="{{args.service-name}}"}[2m]))
---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: performance-check
  namespace: production
spec:
  args:
  - name: service-name
  metrics:
  - name: response-time-p95
    interval: 1m
    count: 5
    successCondition: result < 1000
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus:9090
        query: |
          histogram_quantile(0.95,
            rate(http_request_duration_seconds_bucket{service="{{args.service-name}}"}[2m])
          ) * 1000
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rollback-scripts
  namespace: production
data:
  auto-rollback.sh: |
    #!/bin/bash
    set -e
    
    DEPLOYMENT=$1
    NAMESPACE=$2
    THRESHOLD=$3
    
    # Get current error rate
    ERROR_RATE=$(kubectl exec -n monitoring prometheus-0 -- \
      promtool query instant \
      'sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))')
    
    # Check if error rate exceeds threshold
    if (( $(echo "$ERROR_RATE > $THRESHOLD" | bc -l) )); then
      echo "Error rate $ERROR_RATE exceeds threshold $THRESHOLD. Rolling back..."
      kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE
      kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE
      
      # Send notification
      curl -X POST https://hooks.slack.com/services/YOUR/WEBHOOK \
        -d "{\"text\":\"Automatic rollback triggered for $DEPLOYMENT due to high error rate\"}"
    fi
  
  manual-rollback.sh: |
    #!/bin/bash
    set -e
    
    DEPLOYMENT=$1
    NAMESPACE=$2
    REVISION=${3:-0}
    
    if [ "$REVISION" -eq 0 ]; then
      echo "Rolling back to previous revision..."
      kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE
    else
      echo "Rolling back to revision $REVISION..."
      kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE --to-revision=$REVISION
    fi
    
    kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE
    echo "Rollback completed successfully"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: health-check-rollback
  namespace: production
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: health-check
            image: curlimages/curl:latest
            command:
            - sh
            - -c
            - |
              HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://myapp/health)
              if [ "$HEALTH_STATUS" != "200" ]; then
                echo "Health check failed. Initiating rollback..."
                kubectl rollout undo deployment/myapp -n production
              fi
          restartPolicy: OnFailure
          serviceAccountName: rollback-sa
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rollback-sa
  namespace: production
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rollback-role
  namespace: production
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "patch", "update"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rollback-binding
  namespace: production
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rollback-role
subjects:
- kind: ServiceAccount
  name: rollback-sa
  namespace: production
