# ModSecurity Recommended Configuration
# Based on OWASP ModSecurity Core Rule Set

# -- Rule engine initialization ----------------------------------------------
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecResponseBodyMimeType text/plain text/html text/xml
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject
SecRequestBodyJsonDepthLimit 512
SecRequestBodyInMemoryLimit 131072
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# -- Debug log configuration -------------------------------------------------
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0

# -- Audit log configuration -------------------------------------------------
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# -- Miscellaneous -----------------------------------------------------------
SecArgumentSeparator &
SecCookieFormat 0
SecTmpDir /tmp/
SecDataDir /tmp/
SecUploadDir /tmp/
SecUploadKeepFiles Off
SecUploadFileMode 0600

# -- Unicode Mapping ---------------------------------------------------------
SecUnicodeMapFile unicode.mapping 20127

# -- Status engine -----------------------------------------------------------
SecStatusEngine On

# -- Collection timeout ------------------------------------------------------
SecCollectionTimeout 600

# -- Default actions ---------------------------------------------------------
SecDefaultAction "phase:1,log,auditlog,pass"
SecDefaultAction "phase:2,log,auditlog,pass"

# -- Content-Type handling ---------------------------------------------------
SecRule REQUEST_HEADERS:Content-Type "(?:application(?:/soap\+|/)|text/)xml" \
    "id:'200000',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"

SecRule REQUEST_HEADERS:Content-Type "application/json" \
    "id:'200001',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"

SecRule REQUEST_HEADERS:Content-Type "application/x-www-form-urlencoded" \
    "id:'200002',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=URLENCODED"

SecRule REQUEST_HEADERS:Content-Type "multipart/form-data" \
    "id:'200003',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=MULTIPART"

# -- Collaborative detection severity levels ---------------------------------
SecAction "id:900000,phase:1,nolog,pass,t:none,setvar:tx.blocking_paranoia_level=2"
SecAction "id:900001,phase:1,nolog,pass,t:none,setvar:tx.detection_paranoia_level=2"

# -- Collaborative detection strictness --------------------------------------
SecAction "id:900010,phase:1,nolog,pass,t:none,setvar:tx.enforce_bodyproc_urlencoded=1"
SecAction "id:900011,phase:1,nolog,pass,t:none,setvar:tx.allowed_methods=GET HEAD POST OPTIONS"
SecAction "id:900012,phase:1,nolog,pass,t:none,setvar:tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|"
SecAction "id:900013,phase:1,nolog,pass,t:none,setvar:tx.allowed_request_content_type_charset=|utf-8| |iso-8859-1| |iso-8859-15| |windows-1252|"
SecAction "id:900014,phase:1,nolog,pass,t:none,setvar:tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0"
SecAction "id:900015,phase:1,nolog,pass,t:none,setvar:tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .rdb/ .resources/ .resx/ .sql/ .swp/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/"
SecAction "id:900016,phase:1,nolog,pass,t:none,setvar:tx.restricted_headers=/proxy/ /lock-token/ /content-range/ /if/ /x-forwarded-for/"

# -- Anomaly Scoring ---------------------------------------------------------
SecAction "id:900100,phase:1,nolog,pass,t:none,setvar:tx.inbound_anomaly_score_threshold=5"
SecAction "id:900101,phase:1,nolog,pass,t:none,setvar:tx.outbound_anomaly_score_threshold=4"

# -- Application defenses ----------------------------------------------------
SecAction "id:900200,phase:1,nolog,pass,t:none,setvar:tx.do_reput_block=0"
SecAction "id:900201,phase:1,nolog,pass,t:none,setvar:tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json|"

# -- HTTP policy settings ----------------------------------------------------
SecAction "id:900300,phase:1,nolog,pass,t:none,setvar:tx.max_num_args=255"
SecAction "id:900301,phase:1,nolog,pass,t:none,setvar:tx.arg_name_length=100"
SecAction "id:900302,phase:1,nolog,pass,t:none,setvar:tx.arg_length=400"
SecAction "id:900303,phase:1,nolog,pass,t:none,setvar:tx.total_arg_length=64000"
SecAction "id:900304,phase:1,nolog,pass,t:none,setvar:tx.max_file_size=1048576"
SecAction "id:900305,phase:1,nolog,pass,t:none,setvar:tx.combined_file_sizes=1048576"
