# Custom Rate Limiting Rules
# Advanced rate limiting and DDoS protection

# Initialize IP collection
SecAction \
    "id:14000,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{REMOTE_ADDR}"

# General request rate limiting
SecRule IP:REQUEST_COUNT "@gt 100" \
    "id:14001,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Rate limit exceeded - General requests',\
    setvar:ip.request_count=+1,\
    expirevar:ip.request_count=60"

# API endpoint rate limiting
SecRule REQUEST_URI "@beginsWith /api/" \
    "id:14002,\
    phase:1,\
    chain,\
    pass,\
    setvar:ip.api_count=+1"
    SecRule IP:API_COUNT "@gt 30" \
        "deny,\
        status:429,\
        log,\
        msg:'Rate limit exceeded - API requests',\
        expirevar:ip.api_count=60"

# Login endpoint rate limiting
SecRule REQUEST_URI "@beginsWith /login" \
    "id:14003,\
    phase:1,\
    chain,\
    pass,\
    setvar:ip.login_count=+1"
    SecRule IP:LOGIN_COUNT "@gt 5" \
        "deny,\
        status:429,\
        log,\
        msg:'Rate limit exceeded - Login attempts',\
        expirevar:ip.login_count=300"

# Burst protection
SecRule IP:REQUEST_COUNT "@gt 200" \
    "id:14004,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Burst limit exceeded',\
    setvar:ip.blocked=1,\
    expirevar:ip.blocked=600"
