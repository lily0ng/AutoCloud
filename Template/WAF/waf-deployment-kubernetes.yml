---
# WAF Deployment for Kubernetes
# Nginx + ModSecurity + OWASP CRS

apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-modsecurity-config
  namespace: waf-system
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    load_module modules/ngx_http_modsecurity_module.so;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;
    
    events {
        worker_connections 4096;
    }
    
    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        modsecurity on;
        modsecurity_rules_file /etc/nginx/modsec/main.conf;
        
        server {
            listen 80;
            server_name _;
            
            location / {
                proxy_pass http://backend-service:8080;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            }
        }
    }
  
  modsecurity.conf: |
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess Off
    SecAuditEngine RelevantOnly
    SecAuditLog /var/log/modsec_audit.log
    Include /etc/nginx/modsec/crs-setup.conf
    Include /etc/nginx/modsec/rules/*.conf
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-waf
  namespace: waf-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-waf
  template:
    metadata:
      labels:
        app: nginx-waf
    spec:
      containers:
      - name: nginx-modsecurity
        image: owasp/modsecurity-crs:nginx-alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: modsec-config
          mountPath: /etc/nginx/modsec/modsecurity.conf
          subPath: modsecurity.conf
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-modsecurity-config
      - name: modsec-config
        configMap:
          name: nginx-modsecurity-config
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-waf
  namespace: waf-system
spec:
  selector:
    app: nginx-waf
  ports:
  - port: 80
    targetPort: 80
  type: LoadBalancer
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-waf-hpa
  namespace: waf-system
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx-waf
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
