# Apache ModSecurity Configuration
# Production-ready WAF setup with OWASP CRS

<IfModule security2_module>
    # ModSecurity Core Engine
    SecRuleEngine On
    
    # Request body handling
    SecRequestBodyAccess On
    SecRequestBodyLimit 13107200
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyLimitAction Reject
    SecRequestBodyInMemoryLimit 131072
    
    # Response body handling
    SecResponseBodyAccess Off
    SecResponseBodyMimeType text/plain text/html text/xml
    SecResponseBodyLimit 524288
    SecResponseBodyLimitAction ProcessPartial
    
    # Filesystem configuration
    SecTmpDir /tmp/
    SecDataDir /tmp/
    SecUploadDir /tmp/
    SecUploadKeepFiles Off
    SecUploadFileMode 0600
    
    # Debug log
    SecDebugLog /var/log/apache2/modsec_debug.log
    SecDebugLogLevel 0
    
    # Audit log
    SecAuditEngine RelevantOnly
    SecAuditLogRelevantStatus "^(?:5|4(?!04))"
    SecAuditLogParts ABIJDEFHZ
    SecAuditLogType Serial
    SecAuditLog /var/log/apache2/modsec_audit.log
    
    # Miscellaneous
    SecArgumentSeparator &
    SecCookieFormat 0
    SecStatusEngine On
    SecServerSignature "Apache"
    
    # PCRE Tuning
    SecPcreMatchLimit 100000
    SecPcreMatchLimitRecursion 100000
    
    # Unicode mapping
    SecUnicodeMapFile unicode.mapping 20127
    
    # Collection timeout
    SecCollectionTimeout 600
    
    # Include OWASP CRS
    IncludeOptional /etc/modsecurity/crs-setup.conf
    IncludeOptional /etc/modsecurity/rules/*.conf
    
    # Include custom rules
    IncludeOptional /etc/modsecurity/custom-rules/*.conf
</IfModule>

# Security Headers
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Remove server information
    Header always unset X-Powered-By
    Header always unset Server
    ServerTokens Prod
    ServerSignature Off
</IfModule>

# Rate Limiting
<IfModule mod_ratelimit.c>
    <Location />
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 400
    </Location>
</IfModule>

# Evasive Module (DDoS Protection)
<IfModule mod_evasive20.c>
    DOSHashTableSize 3097
    DOSPageCount 5
    DOSSiteCount 100
    DOSPageInterval 1
    DOSSiteInterval 1
    DOSBlockingPeriod 60
    DOSEmailNotify security@example.com
    DOSLogDir /var/log/apache2/mod_evasive
</IfModule>
