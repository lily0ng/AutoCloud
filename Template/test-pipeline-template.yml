---
# Test Pipeline Template
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: test-pipeline
  namespace: cicd
spec:
  params:
    - name: git-url
      type: string
    - name: git-revision
      type: string
      default: main
  
  workspaces:
    - name: shared-workspace
  
  tasks:
    - name: fetch-code
      taskRef:
        name: git-clone
      workspaces:
        - name: output
          workspace: shared-workspace
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
    
    - name: unit-tests
      runAfter: [fetch-code]
      taskRef:
        name: run-tests
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: test-type
          value: unit
        - name: test-command
          value: "npm run test:unit"
    
    - name: integration-tests
      runAfter: [unit-tests]
      taskRef:
        name: run-tests
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: test-type
          value: integration
        - name: test-command
          value: "npm run test:integration"
    
    - name: e2e-tests
      runAfter: [integration-tests]
      taskRef:
        name: run-tests
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: test-type
          value: e2e
        - name: test-command
          value: "npm run test:e2e"
    
    - name: code-coverage
      runAfter: [unit-tests, integration-tests]
      taskRef:
        name: coverage-report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: lint
      runAfter: [fetch-code]
      taskRef:
        name: run-lint
      workspaces:
        - name: source
          workspace: shared-workspace
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: run-tests
  namespace: cicd
spec:
  params:
    - name: test-type
      type: string
    - name: test-command
      type: string
  workspaces:
    - name: source
  steps:
    - name: run-test
      image: node:18
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/sh
        set -e
        npm ci
        $(params.test-command)
      env:
        - name: CI
          value: "true"
    - name: publish-results
      image: node:18
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/sh
        if [ -f "test-results.xml" ]; then
          echo "Test results found"
          cat test-results.xml
        fi
