---
- name: Security Hardening
  hosts: all
  become: yes
  tasks:
    - name: Update all packages
      apt:
        upgrade: full
        update_cache: yes

    - name: Configure SSH hardening
      template:
        src: templates/sshd_config.j2
        dest: /etc/ssh/sshd_config
      notify: restart ssh

    - name: Set up automatic security updates
      apt:
        name: unattended-upgrades
        state: present

    - name: Configure automatic updates
      template:
        src: templates/20auto-upgrades.j2
        dest: /etc/apt/apt.conf.d/20auto-upgrades

    - name: Install security packages
      apt:
        name:
          - rkhunter
          - chkrootkit
          - auditd
        state: present

    - name: Configure system audit
      template:
        src: templates/audit.rules.j2
        dest: /etc/audit/rules.d/audit.rules
      notify: restart auditd

  handlers:
    - name: restart ssh
      service:
        name: ssh
        state: restarted

    - name: restart auditd
      service:
        name: auditd
        state: restarted
